name: Build and release Calibre MCP plugin

on:
  push:
    tags:
      - "v*"

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install websockets for bundling
        run: |
          pip install "websockets>=12.0"

      - name: Build plugin zip (with websockets)
        run: |
          set -e

          mkdir -p build/plugin dist

          # Copy calibre plugin files
          rsync -av calibre_plugin/ build/plugin/

          # Copy MCP server code (falls du es im Plugin brauchst)
          rsync -av src/calibre_mcp_server/ build/plugin/calibre_mcp_server/

          # Copy websockets package into plugin root
          python - << 'PY'
          import inspect
          import pathlib
          import shutil
          import websockets

          # Determine source directory of websockets package
          src = pathlib.Path(inspect.getfile(websockets)).parent

          # Destination inside plugin bundle
          dest = pathlib.Path("build/plugin/websockets")

          # Ensure clean destination
          if dest.exists():
              shutil.rmtree(dest)

          # Copy entire websockets package
          shutil.copytree(src, dest)
          PY

          # Create final plugin zip
          cd build/plugin
          zip -r ../../dist/calibre-mcp-plugin.zip .

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: calibre-mcp-plugin
          path: dist/calibre-mcp-plugin.zip

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/calibre-mcp-plugin.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
